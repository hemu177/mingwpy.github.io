<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Issues &#8212; mingwpy 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="How to correctly link to UCRT (and why it works that way)" href="ucrt.html" />
    <link rel="prev" title="BLAS / LAPACK on Windows" href="blas_lapack.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="issues">
<h1>Issues<a class="headerlink" href="#issues" title="Permalink to this headline">¶</a></h1>
<div class="section" id="finding-the-mingw-w64-runtime-library-code">
<h2>Finding the mingw-w64 runtime library code<a class="headerlink" href="#finding-the-mingw-w64-runtime-library-code" title="Permalink to this headline">¶</a></h2>
<p>It is difficult to guarantee that a compiled Python extension will be able to
find the correct version of runtime DLLs – see: <a class="reference external" href="https://github.com/numpy/numpy/wiki/windows-dll-notes">Windows DLL notes</a>.</p>
<p>One method to avoid this problem is to include any necessary runtime code in
the compiled extension.  This can be done by:</p>
<ul class="simple">
<li>Compiling all extensions (DLLs) with <code class="docutils literal"><span class="pre">-static-libgcc</span></code>,
<code class="docutils literal"><span class="pre">-static-libstdc++</span></code> etc flags;</li>
<li>Using a gcc compiler toolchain that does static linking to runtimes by
default.  This is a &#8220;static toolchain&#8221;.  The <a class="reference external" href="https://github.com/niXman/mingw-builds">mingw-builds</a> set of scripts
builds such a toolchain by passing the <code class="docutils literal"><span class="pre">--static-gcc</span></code> argument (see:
<a class="reference external" href="https://github.com/niXman/mingw-builds/blob/17ae841dcf6e72badad7941a06d631edaf687436/build#L218">mingw-build build file</a>;</li>
</ul>
<p>Using these approaches, all the necessary object code from the GCC runtimes
will be statically linked into the binaries. As a consequence the binary size
will be increased in comparison to the standard toolchains / dynamic linking.
The advantage is, that there will be no dependency to external GCC runtime
libraries, so the deployment of Python extensions is greatly improved.</p>
<p>However, exception heavy C++ programs such as QT should be compiled with
shared runtimes to avoid problems with exception handling over DLL boundaries.</p>
<p>For building typically Python extensions a customized static GCC toolchain is
the best compromise IMHO.</p>
<p><strong>Note from njs:</strong> This definitely sounds like the right thing to try
initially, <em>but</em> it&#8217;s possible (likely?) that we&#8217;ll run into the <a class="reference external" href="http://stevedower.id.au/blog/building-for-python-3-5-part-two/">same
problem that Steve Dower ran into with trying to set up MSVC to
statically link the runtime code</a>,
i.e., TLS keys are a limited resource, so if libgcc allocates any TLS
keys at startup, and every extension module has its own copy of
libgcc, then this puts a hard cap on how many Python extension modules
can be loaded into a single process. Which is really bad (consider
projects like Sage that make heavy use of Cython, and each Cython
source file creates a separate extension...). Or at least, it&#8217;s really
bad IF it&#8217;s a problem at all. In fact I have no idea whether libgcc
allocates any TLS keys at startup &#8211; introspecting a handy copy of
libgcc*.dll shows that it does contain references to <code class="docutils literal"><span class="pre">TlsAlloc</span></code>, but
I don&#8217;t know whether they&#8217;re called under ordinary circumstances. So
we should start with static linking, but have a fallback plan in case
it doesn&#8217;t work.</p>
<p>Worst case, I think our fallback plan is to switch back to dynamic
linking, and require projects to use one of the standard dynamic
linking strategies that we&#8217;ve discussed elsewhere. Possibly this means
the mingwpy project will eventually want to start shipping a
mingw-w64-runtime wheel, similar to what we&#8217;ve discussed doing with
BLAS dlls, that projects could declare a dependency on.</p>
</div>
<div class="section" id="ms-gcc-abi-incompatibilities">
<h2>MS / gcc ABI incompatibilities<a class="headerlink" href="#ms-gcc-abi-incompatibilities" title="Permalink to this headline">¶</a></h2>
<p>There is a win32 default stack alignment incompatibility: GCC code provides
(and assumes) 16 (2^4) byte stack alignment since GCC4.6, but MSVC uses 4
(2^2) byte stack alignment.</p>
<p>Win64 X86_64 is not affected.  This issue is the major cause for segment
faults on 32bit systems.</p>
<p>The solution is to use the <code class="docutils literal"><span class="pre">-mincoming-stack-boundary=2</span></code> flag for compiling.</p>
<p>From:
<a class="reference external" href="https://docs.google.com/document/d/1lnWj0UhxJkeK0WyQdoW2opQKJfIseaN0qimFZbFOOYs">https://docs.google.com/document/d/1lnWj0UhxJkeK0WyQdoW2opQKJfIseaN0qimFZbFOOYs</a></p>
<blockquote>
<div>Stack alignment discussion: GCC upstream agrees the default should be
compatible with MSVC, however it’s not. GCC will likely not accept a patch
to go back to the pre-4.6 stack alignment. Needs follow-up with Kai Tietz
(he asked for a test case). Note: 32-bit only problem.</div></blockquote>
<p>Some googling suggests that the case where this problem will arise specifically
is when you combine functions that contain SSE instructions (which are less
forgiving of bad alignment than most of the x86 ISA), then called from code
that doesn&#8217;t guarantee the right stack alignment &#8211; online hints suggest that
this tends to happen with windows threads. This is consistent with the
observation that OpenBLAS in particular blows up without this flag (b/c
OpenBLAS is a heavy user of SSE + threads).</p>
<p>(See: <a class="reference external" href="http://www.peterstock.co.uk/games/mingw_sse/">1</a>, <a class="reference external" href="http://www.sourceware.org/ml/pthreads-win32/2008/msg00056.html">2</a>)</p>
<p>It&#8217;s likely that a sufficient test case to give to Kai would be a
program that spawns a bunch of threads running the following
function:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="n">thread</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">param</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">int</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">intptr_t</span> <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">intptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Thread stack %p is not 16-byte aligned!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and if this prints any output then we have our proof that
<code class="docutils literal"><span class="pre">-mincoming-stack-boundary=2</span></code> is necessary for Windows/MSVC
compatibility.</p>
</div>
<div class="section" id="choice-of-msvc-runtime">
<h2>Choice of MSVC runtime<a class="headerlink" href="#choice-of-msvc-runtime" title="Permalink to this headline">¶</a></h2>
<p>All code in a single process should use one single version of the MSVC runtime
(see <a class="reference external" href="https://msdn.microsoft.com/en-us/library/ms235460.aspx">MSDN article</a>).</p>
<p>The Python that gets installed from downloading from <a class="reference external" href="https://www.python.org">https://www.python.org</a> is
build with MSVC.  Therefore Python extensions for Python installed from these
installers must use the same MSVC CRT.</p>
<p>Specifically (see: <a class="reference external" href="https://matthew-brett.github.io/pydagogue/python_msvc.html#visual-studio-versions-used-to-compile-distributed-python-binaries">Python and MSVC versions</a>):</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="21%" />
<col width="54%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Python version</th>
<th class="head">VC++ version</th>
<th class="head">C runtime</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>2.7.6</td>
<td>9.0 / 2008</td>
<td>MSVCR90.DLL</td>
</tr>
<tr class="row-odd"><td>3.2.3</td>
<td>9.0 / 2008</td>
<td>MSVCR90.DLL</td>
</tr>
<tr class="row-even"><td>3.3.5</td>
<td>10.0 / 2010</td>
<td>MSVCR100.DLL</td>
</tr>
<tr class="row-odd"><td>3.4.0</td>
<td>10.0 / 2010</td>
<td>MSVCR100.DLL</td>
</tr>
<tr class="row-even"><td>3.5.0</td>
<td>14.0 / 2015</td>
<td>UCRTBASE.DLL / VCRUNTIME140.DLL</td>
</tr>
</tbody>
</table>
<p>By default, mingw-w64 links to the MSVCRT.DLL.  This is a CRT dating from MSVC
4.2, but updated to contain the runtimes for MSVC 6.0, plus some more recent
(&gt;6.0) API calls (see these comments on <a class="reference external" href="http://sourceforge.net/p/mingw-w64/wiki2/The%20case%20against%20msvcrt.dll">using MSVCRT.DLL from Mingw-w64</a>).</p>
<p>It is possible, using <a class="reference external" href="http://www.mingw.org/wiki/HOWTO_Use_the_GCC_specs_file">spec files</a>, to ask mingw-w64
to link to other versions of the MSVC runtimes.  This could induce bad
behavior if there is any API mismatch between the implementations in the
mingw-w64 headers (tuned to MSVCRT.DLL) and those in the newer C runtime.</p>
<p>What workarounds are necessary to use MSVC 9.0 / 2008 (Python 2.7)?</p>
</div>
<div class="section" id="the-vs-14-2015-runtime">
<h2>The VS 14 / 2015 runtime<a class="headerlink" href="#the-vs-14-2015-runtime" title="Permalink to this headline">¶</a></h2>
<p>Matters get more confusing for the latest (at time of writing) MSVC, version
14 (MSVS 2015).</p>
<p>Firstly, the CRT is now two files:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ucrtbase.dll</span></code>;</li>
<li><code class="docutils literal"><span class="pre">vcruntime140.dll</span></code>;</li>
</ul>
<p>of which the first will be kept with a backwards-compatible API / ABI across
new VS releases.</p>
<p>Second, linking correctly to these new 2015 libraries requires some
careful handling of the DLL import library (the &#8221;.lib&#8221; or &#8221;.a&#8221; file
that&#8217;s used for actually linking to a .dll on Windows). We <em>don&#8217;t</em>
want to use the standard mingw-w64 trick of dumping the symbols from
<code class="docutils literal"><span class="pre">ucrtbase.dll</span></code> and using them to generate a import library; that
will do the wrong thing. To understand why and what the right thing
is, read this:</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="ucrt.html">How to correctly link to UCRT (and why it works that way)</a></li>
</ul>
</div>
<p>So that&#8217;s how to handle <code class="docutils literal"><span class="pre">ucrtbase.dll</span></code>. 99% of the things we care
about are in the safe unversioned <code class="docutils literal"><span class="pre">ucrtbase.dll</span></code>. There remains some
question of what to do with <code class="docutils literal"><span class="pre">vcruntime140.dll</span></code>. The ideal would be
that our toolchain simply doesn&#8217;t link to it at all. It looks like the
symbols it provides are:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Ordinal</span><span class="o">/</span><span class="n">Name</span> <span class="n">Pointer</span><span class="p">]</span> <span class="n">Table</span>
      <span class="p">[</span>   <span class="mi">0</span><span class="p">]</span> <span class="n">_CreateFrameInfo</span>
      <span class="p">[</span>   <span class="mi">1</span><span class="p">]</span> <span class="n">_CxxThrowException</span>
      <span class="p">[</span>   <span class="mi">2</span><span class="p">]</span> <span class="n">_FindAndUnlinkFrame</span>
      <span class="p">[</span>   <span class="mi">3</span><span class="p">]</span> <span class="n">_IsExceptionObjectToBeDestroyed</span>
      <span class="p">[</span>   <span class="mi">4</span><span class="p">]</span> <span class="n">_SetWinRTOutOfMemoryExceptionCallback</span>
      <span class="p">[</span>   <span class="mi">5</span><span class="p">]</span> <span class="n">__AdjustPointer</span>
      <span class="p">[</span>   <span class="mi">6</span><span class="p">]</span> <span class="n">__BuildCatchObject</span>
      <span class="p">[</span>   <span class="mi">7</span><span class="p">]</span> <span class="n">__BuildCatchObjectHelper</span>
      <span class="p">[</span>   <span class="mi">8</span><span class="p">]</span> <span class="n">__C_specific_handler</span>
      <span class="p">[</span>   <span class="mi">9</span><span class="p">]</span> <span class="n">__C_specific_handler_noexcept</span>
      <span class="p">[</span>  <span class="mi">10</span><span class="p">]</span> <span class="n">__CxxDetectRethrow</span>
      <span class="p">[</span>  <span class="mi">11</span><span class="p">]</span> <span class="n">__CxxExceptionFilter</span>
      <span class="p">[</span>  <span class="mi">12</span><span class="p">]</span> <span class="n">__CxxFrameHandler</span>
      <span class="p">[</span>  <span class="mi">13</span><span class="p">]</span> <span class="n">__CxxFrameHandler2</span>
      <span class="p">[</span>  <span class="mi">14</span><span class="p">]</span> <span class="n">__CxxFrameHandler3</span>
      <span class="p">[</span>  <span class="mi">15</span><span class="p">]</span> <span class="n">__CxxQueryExceptionSize</span>
      <span class="p">[</span>  <span class="mi">16</span><span class="p">]</span> <span class="n">__CxxRegisterExceptionObject</span>
      <span class="p">[</span>  <span class="mi">17</span><span class="p">]</span> <span class="n">__CxxUnregisterExceptionObject</span>
      <span class="p">[</span>  <span class="mi">18</span><span class="p">]</span> <span class="n">__DestructExceptionObject</span>
      <span class="p">[</span>  <span class="mi">19</span><span class="p">]</span> <span class="n">__FrameUnwindFilter</span>
      <span class="p">[</span>  <span class="mi">20</span><span class="p">]</span> <span class="n">__GetPlatformExceptionInfo</span>
      <span class="p">[</span>  <span class="mi">21</span><span class="p">]</span> <span class="n">__NLG_Dispatch2</span>
      <span class="p">[</span>  <span class="mi">22</span><span class="p">]</span> <span class="n">__NLG_Return2</span>
      <span class="p">[</span>  <span class="mi">23</span><span class="p">]</span> <span class="n">__RTCastToVoid</span>
      <span class="p">[</span>  <span class="mi">24</span><span class="p">]</span> <span class="n">__RTDynamicCast</span>
      <span class="p">[</span>  <span class="mi">25</span><span class="p">]</span> <span class="n">__RTtypeid</span>
      <span class="p">[</span>  <span class="mi">26</span><span class="p">]</span> <span class="n">__TypeMatch</span>
      <span class="p">[</span>  <span class="mi">27</span><span class="p">]</span> <span class="n">__current_exception</span>
      <span class="p">[</span>  <span class="mi">28</span><span class="p">]</span> <span class="n">__current_exception_context</span>
      <span class="p">[</span>  <span class="mi">29</span><span class="p">]</span> <span class="n">__intrinsic_setjmp</span>
      <span class="p">[</span>  <span class="mi">30</span><span class="p">]</span> <span class="n">__intrinsic_setjmpex</span>
      <span class="p">[</span>  <span class="mi">31</span><span class="p">]</span> <span class="n">__processing_throw</span>
      <span class="p">[</span>  <span class="mi">32</span><span class="p">]</span> <span class="n">__report_gsfailure</span>
      <span class="p">[</span>  <span class="mi">33</span><span class="p">]</span> <span class="n">__std_exception_copy</span>
      <span class="p">[</span>  <span class="mi">34</span><span class="p">]</span> <span class="n">__std_exception_destroy</span>
      <span class="p">[</span>  <span class="mi">35</span><span class="p">]</span> <span class="n">__std_terminate</span>
      <span class="p">[</span>  <span class="mi">36</span><span class="p">]</span> <span class="n">__std_type_info_compare</span>
      <span class="p">[</span>  <span class="mi">37</span><span class="p">]</span> <span class="n">__std_type_info_destroy_list</span>
      <span class="p">[</span>  <span class="mi">38</span><span class="p">]</span> <span class="n">__std_type_info_hash</span>
      <span class="p">[</span>  <span class="mi">39</span><span class="p">]</span> <span class="n">__std_type_info_name</span>
      <span class="p">[</span>  <span class="mi">40</span><span class="p">]</span> <span class="n">__telemetry_main_invoke_trigger</span>
      <span class="p">[</span>  <span class="mi">41</span><span class="p">]</span> <span class="n">__telemetry_main_return_trigger</span>
      <span class="p">[</span>  <span class="mi">42</span><span class="p">]</span> <span class="n">__unDName</span>
      <span class="p">[</span>  <span class="mi">43</span><span class="p">]</span> <span class="n">__unDNameEx</span>
      <span class="p">[</span>  <span class="mi">44</span><span class="p">]</span> <span class="n">__uncaught_exception</span>
      <span class="p">[</span>  <span class="mi">45</span><span class="p">]</span> <span class="n">__uncaught_exceptions</span>
      <span class="p">[</span>  <span class="mi">46</span><span class="p">]</span> <span class="n">__vcrt_GetModuleFileNameW</span>
      <span class="p">[</span>  <span class="mi">47</span><span class="p">]</span> <span class="n">__vcrt_GetModuleHandleW</span>
      <span class="p">[</span>  <span class="mi">48</span><span class="p">]</span> <span class="n">__vcrt_InitializeCriticalSectionEx</span>
      <span class="p">[</span>  <span class="mi">49</span><span class="p">]</span> <span class="n">__vcrt_LoadLibraryExW</span>
      <span class="p">[</span>  <span class="mi">50</span><span class="p">]</span> <span class="n">_get_purecall_handler</span>
      <span class="p">[</span>  <span class="mi">51</span><span class="p">]</span> <span class="n">_get_unexpected</span>
      <span class="p">[</span>  <span class="mi">52</span><span class="p">]</span> <span class="n">_is_exception_typeof</span>
      <span class="p">[</span>  <span class="mi">53</span><span class="p">]</span> <span class="n">_local_unwind</span>
      <span class="p">[</span>  <span class="mi">54</span><span class="p">]</span> <span class="n">_purecall</span>
      <span class="p">[</span>  <span class="mi">55</span><span class="p">]</span> <span class="n">_set_purecall_handler</span>
      <span class="p">[</span>  <span class="mi">56</span><span class="p">]</span> <span class="n">_set_se_translator</span>
      <span class="p">[</span>  <span class="mi">57</span><span class="p">]</span> <span class="n">longjmp</span>
      <span class="p">[</span>  <span class="mi">58</span><span class="p">]</span> <span class="n">memchr</span>
      <span class="p">[</span>  <span class="mi">59</span><span class="p">]</span> <span class="n">memcmp</span>
      <span class="p">[</span>  <span class="mi">60</span><span class="p">]</span> <span class="n">memcpy</span>
      <span class="p">[</span>  <span class="mi">61</span><span class="p">]</span> <span class="n">memmove</span>
      <span class="p">[</span>  <span class="mi">62</span><span class="p">]</span> <span class="n">memset</span>
      <span class="p">[</span>  <span class="mi">63</span><span class="p">]</span> <span class="n">set_unexpected</span>
      <span class="p">[</span>  <span class="mi">64</span><span class="p">]</span> <span class="n">strchr</span>
      <span class="p">[</span>  <span class="mi">65</span><span class="p">]</span> <span class="n">strrchr</span>
      <span class="p">[</span>  <span class="mi">66</span><span class="p">]</span> <span class="n">strstr</span>
      <span class="p">[</span>  <span class="mi">67</span><span class="p">]</span> <span class="n">unexpected</span>
      <span class="p">[</span>  <span class="mi">68</span><span class="p">]</span> <span class="n">wcschr</span>
      <span class="p">[</span>  <span class="mi">69</span><span class="p">]</span> <span class="n">wcsrchr</span>
      <span class="p">[</span>  <span class="mi">70</span><span class="p">]</span> <span class="n">wcsstr</span>
</pre></div>
</div>
<p>So, numbers 0 through 56 appear to me (= njs) to be internal machinery
used for C++ exceptions and <a class="reference external" href="https://en.wikipedia.org/wiki/Run-time_type_information">RTTI</a>. I&#8217;m
pretty sure this stuff is all irrelevant to us, because libgcc should
already be providing the equivalent machinery needed for any C++ code
that&#8217;s compiled using gcc, and trying to achieve C++ ABI compatibility
between MSVC and gcc is outside the scope of this project.</p>
<p>Of the rest, <code class="docutils literal"><span class="pre">set_unexpected</span></code> and <code class="docutils literal"><span class="pre">unexpected</span></code> can be ignored,
because they&#8217;re yet more C++-related nonsense that <a class="reference external" href="https://msdn.microsoft.com/en-us/library/h46t5b69.aspx">apparently isn&#8217;t
even used anymore</a>), but the
others are real standard C functions, and a quick check reveals that
most of them are <em>not</em> available in <code class="docutils literal"><span class="pre">ucrtbase.dll</span></code>, but only here in
<code class="docutils literal"><span class="pre">vcruntime140.dll</span></code>.</p>
<p>These can be broken down further into two categories:</p>
<ol class="arabic">
<li><p class="first">Simple string functions: <code class="docutils literal"><span class="pre">memchr</span></code>, <code class="docutils literal"><span class="pre">memcmp</span></code>, <code class="docutils literal"><span class="pre">memcpy</span></code>,
<code class="docutils literal"><span class="pre">memmove</span></code>, <code class="docutils literal"><span class="pre">memset</span></code>, <code class="docutils literal"><span class="pre">strchr</span></code>, <code class="docutils literal"><span class="pre">strrchr</span></code>, <code class="docutils literal"><span class="pre">strstr</span></code>,
<code class="docutils literal"><span class="pre">wcschr</span></code>, <code class="docutils literal"><span class="pre">wcsrchr</span></code>, <code class="docutils literal"><span class="pre">wcsstr</span></code>. These are crucial functions
that we definitely need to support, but there&#8217;s no particular
advantage to using the implementation from
<code class="docutils literal"><span class="pre">vcruntime140.dll</span></code>. They can just be reimplemented inside
mingw-w64. (Basic working versions are trivial; making them fast
takes more work, but could be lifted from BSD libc or whatever.)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">setjmp</span></code> / <code class="docutils literal"><span class="pre">longjmp</span></code>: Reimplementing these from scratch would
be a huuuuge hassle. Fortunately, they&#8217;re a very advanced and
tricky feature that&#8217;s rarely useful! ...But unfortunately, both
numpy and scipy actually use them. Numpy&#8217;s usage might be optional
(it has fallback code for if they&#8217;re not available, and the only
cost would be that you couldn&#8217;t hit control-C to interrupt a
long-running inner-loop &#8211; and this may not even work on Windows
in the first place), but scipy uses them for actual flow control
D-:. It&#8217;s possible this could just be fixed in scipy if necessary.</p>
<p>setjmp/longjmp may also be needed for exception handling to work in
32-bit mingw-w64-compiled C++ code. Though I&#8217;m actually a bit
confused on this point, since the copy of <code class="docutils literal"><span class="pre">libgcc_s_sjlj-1.dll</span></code>
that I have on my Debian box doesn&#8217;t actually seem to contain any
references to the <code class="docutils literal"><span class="pre">setjmp</span></code> or <code class="docutils literal"><span class="pre">longjmp</span></code> symbols in the CRT?</p>
<p>On further investigation it looks like <em>maybe</em> the reason libgcc
does not import setjmp/longjmp from the CRT is that it is built to
use the gcc builtins <code class="docutils literal"><span class="pre">__builtin_setjmp</span></code> / <code class="docutils literal"><span class="pre">__builtin_longjmp</span></code>
instead? If these exist and are functional in mingw-w64 builds then
that is an even better solution &#8211; we just need to set up the
headers so that user code that tries to call setjmp/longjmp are
redirected to the builtins. Maybe. Need to check with mingw-w64
folks about this.</p>
</li>
</ol>
</div>
<div class="section" id="math-precision-issues">
<h2>Math precision issues<a class="headerlink" href="#math-precision-issues" title="Permalink to this headline">¶</a></h2>
<p>(Quoting Nathaniel Smith on email):</p>
<blockquote>
<div><p>mingw-w64&#8217;s libm implementations are the borrowed from those used on BSDs,
Linux, etc., and assume &#8211; consistent with the ABI on those other
platforms &#8211; that the x87 FPU will be configured to use 80 bit precision
for intermediate results. MSVC&#8217;s ABI, though, configures the x87 FPU into
64 bit precision mode, and we don&#8217;t want to override that because who
knows what would break.  The result is that when run in MSVC-compatibility
mode, mingw-w64&#8217;s libm code currently assumes that it has higher internal
precision than it actually has, and doesn&#8217;t necessarily produce the right
answers. In particular the trig functions currently are just thin wrappers
around the x87 fsin / fcos / etc. instructions. These are pretty sloppy
and inaccurate, which doesn&#8217;t matter too much if you&#8217;re going to throw
away all the low-order bits anyway... but if you&#8217;re going to keep those
bits then it becomes more of an issue.</p>
<p>[...]</p>
</div></blockquote>
<p>Investigating <code class="docutils literal"><span class="pre">sleef</span></code> library for needed functions.  Nathaniel suggested
libm implementation from bionic (Android&#8217;s libc).</p>
<p>Bionic&#8217;s libm is here: <a class="reference external" href="https://github.com/android/platform_bionic/tree/master/libm/x86">https://github.com/android/platform_bionic/tree/master/libm/x86</a>
Basically what would be needed is just copying these files into mingw-w64 plus
build system updates.</p>
</div>
<div class="section" id="distutils-issues">
<h2>Distutils issues<a class="headerlink" href="#distutils-issues" title="Permalink to this headline">¶</a></h2>
<p>Mingw via Python distutils needs to link extension code to the correct Python
library, e.g. <code class="docutils literal"><span class="pre">libpython27.dll</span></code>.  To do this, mingw needs a library
definition file <code class="docutils literal"><span class="pre">libpython27.a</span></code>.  It is possible to create this file using
the mingw-w64 tools.</p>
<p><em>Query from njs: can&#8217;t we just use the python27.lib that&#8217;s shipped
with CPython itself?</em></p>
<p>numpy distutils currently needs patching to pass correct flags to compiler /
linker.</p>
<p>How to return correct flags to mingw-w64, from Python built with MSVC?</p>
</div>
<div class="section" id="manifest-resources">
<h2>Manifest resources<a class="headerlink" href="#manifest-resources" title="Permalink to this headline">¶</a></h2>
<p>Solution is to extend the GCC toolchain with the Manifest resource files and
ensure linkage with the help of the &#8216;specs&#8217; file.</p>
<p><em>If this is the solution, then what&#8217;s the problem? Carl, could you add
some text here elaborating? (and then delete this comment :-)) -njs</em></p>
</div>
<div class="section" id="blas-lapack-libraries">
<h2>BLAS / LAPACK libraries<a class="headerlink" href="#blas-lapack-libraries" title="Permalink to this headline">¶</a></h2>
<p>There is no silver bullet for the problem of finding fast, reliable BLAS and
LAPACK routines with a suitable license.</p>
<p>See <a class="reference internal" href="blas_lapack.html"><span class="doc">BLAS / LAPACK on Windows</span></a>.</p>
</div>
<div class="section" id="partial-to-do-list">
<h2>Partial to-do list<a class="headerlink" href="#partial-to-do-list" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Implement linking to MSVC 2015 CRT libraries from mingw-w64;<ul>
<li>work out correct method;</li>
<li>discuss with MS developers;</li>
<li>merge to mingw-w64;</li>
</ul>
</li>
<li>Implement high-precision libm;<ul>
<li>decide on library;</li>
<li>merge to mingw-w64;</li>
</ul>
</li>
<li>Develop &#8220;runtime agility&#8221; for mingw-w64 - method of adapting to different
MSVC CRT libraries dynamically.  Maybe 50-60K of developer work / 2 man
months.  On back-burner for mingw-w64 project.</li>
<li>Create buildbot / appveyor scripts to build mingwpy library;</li>
<li>Create test rig for OpenBLAS maybe via numpy, implement on buildbots with
different processors or gcc compile farm.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Issues</a><ul>
<li><a class="reference internal" href="#finding-the-mingw-w64-runtime-library-code">Finding the mingw-w64 runtime library code</a></li>
<li><a class="reference internal" href="#ms-gcc-abi-incompatibilities">MS / gcc ABI incompatibilities</a></li>
<li><a class="reference internal" href="#choice-of-msvc-runtime">Choice of MSVC runtime</a></li>
<li><a class="reference internal" href="#the-vs-14-2015-runtime">The VS 14 / 2015 runtime</a></li>
<li><a class="reference internal" href="#math-precision-issues">Math precision issues</a></li>
<li><a class="reference internal" href="#distutils-issues">Distutils issues</a></li>
<li><a class="reference internal" href="#manifest-resources">Manifest resources</a></li>
<li><a class="reference internal" href="#blas-lapack-libraries">BLAS / LAPACK libraries</a></li>
<li><a class="reference internal" href="#partial-to-do-list">Partial to-do list</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015-2016, Carl Kleffner and collaborators.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="https://github.com/mingwpy/mingwpy.github.io/edit/source/issues.rst"
          rel="nofollow">Edit on GitHub</a>
    </div>

    
    <a href="https://github.com/mingwpy/mingwpy.github.io" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>